#!/usr/bin/env bash

# Define the base directory and default directory
BASE_DIR="$HOME/Second-Brain"
DEFAULT_DIR="$BASE_DIR/Zettelkasten"
IMAGE_DIR="$BASE_DIR/Resources/Images/Zettelkasten"

# Check if a file path is provided
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <file_path>"
    exit 1
fi

# Reconstruct the full file path from all arguments
file="$*"
# If the path is not absolute, prepend the current directory

if [[ ! "$file" = /* ]]; then
    file="$PWD/$file"
fi

echo "Processing file: $file"
# Check if the file name starts with "Pasted"
filename=$(basename "$file")
echo "Filename: $filename"

if [[ "$filename" =~ ^Pasted[[:space:]]image[[:space:]][0-9]+\.png$ ]]; then
    echo "File $filename starts with 'Pasted', moving to image directory."
    # Move the image file
    if mv "$file" "$IMAGE_DIR/"; then
        echo "Successfully moved $filename to $IMAGE_DIR"
        exit 0
    else
        echo "Error moving image file"
        exit 1
    fi
fi

# Ensure the specified file exists
if [[ ! -f "$file" ]]; then
    echo "Error: File $file does not exist."
    exit 1
fi


# Extract the first wikilink after "## Link" in the file
target_dir=$(awk '/^## Links/{flag=1; next} flag && /\[\[([^\]]+)\]\]/{print gensub(/.*\[\[([^\]]+)\]\].*/, "\\1", "g"); exit}' "$file")

# Search for the target directory under BASE_DIR
if [[ -n "$target_dir" ]]; then
    TARGET_PATH=$(find "$BASE_DIR" -type d -name "$target_dir" -print -quit)
else
    TARGET_PATH=""
fi


# Use the default directory if no target directory is found
if [[ -z "$TARGET_PATH" ]]; then
    echo "No target directory found for $file, moving to default directory."
    TARGET_PATH="$DEFAULT_DIR"
else
    echo "Found target directory: $TARGET_PATH"
fi

# Move the file to the target directory
mv "$file" "$TARGET_PATH"
echo "Moved $file to $TARGET_PATH"
